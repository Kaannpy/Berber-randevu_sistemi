@model KuaforRandevuSistemi.Models.AppointmentViewModel

@{
    ViewData["Title"] = "Randevularım";
}

<h1>Randevularım</h1>

<div class="mb-3 d-flex justify-content-between align-items-center">
    <div>
        <a href="@Url.Action("Create", "Appointments")" class="btn btn-primary btn-sm">
            <i class="fas fa-plus-circle me-1"></i> Randevu Oluştur
        </a>
    </div>
    
    <div class="appointment-filters">
        <div class="input-group">
            <input type="text" id="searchAppointments" class="form-control form-control-sm" placeholder="Arama...">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-filter"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Sıralama</h6></li>
                <li><a class="dropdown-item sort-option" href="#" data-sort="date-asc">Tarih: Eski-Yeni</a></li>
                <li><a class="dropdown-item sort-option" href="#" data-sort="date-desc">Tarih: Yeni-Eski</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Filtrele</h6></li>
                <li><a class="dropdown-item filter-option" href="#" data-filter="all">Tümü</a></li>
                <li><a class="dropdown-item filter-option" href="#" data-filter="upcoming">Yaklaşan</a></li>
                <li><a class="dropdown-item filter-option" href="#" data-filter="past">Geçmiş</a></li>
                <li><a class="dropdown-item filter-option" href="#" data-filter="cancelled">İptal Edilenler</a></li>
            </ul>
        </div>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show py-2" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="appointments-container">
    <div class="accordion accordion-flush" id="appointmentsAccordion">
        <div class="accordion-item" id="upcomingSection">
            <h2 class="accordion-header" id="upcomingHeading">
                <button class="accordion-button py-2" type="button" data-bs-toggle="collapse"
                    data-bs-target="#upcomingCollapse" aria-expanded="true" aria-controls="upcomingCollapse">
                    <i class="fas fa-calendar me-2"></i> Yaklaşan Randevular
                    <span class="badge bg-primary ms-2" id="upcomingCount">
                        @(Model.UpcomingAppointments?.Count() ?? 0)
                    </span>
                </button>
            </h2>
            <div id="upcomingCollapse" class="accordion-collapse collapse show" aria-labelledby="upcomingHeading">
                <div class="accordion-body p-2">
                    @if (Model.UpcomingAppointments != null && Model.UpcomingAppointments.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped appointment-table" id="upcomingTable">
                                <thead>
                                    <tr>
                                        <th>Tarih/Saat</th>
                                        <th>Personel</th>
                                        <th>Hizmet/Fiyat</th>
                                        <th>Durum</th>
                                        <th>İşlem</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var appointment in Model.UpcomingAppointments)
                                    {
                                        <tr data-date="@appointment.AppointmentDate.ToString("yyyy-MM-ddTHH:mm:ss")" 
                                            data-staff="@(appointment.Staff?.Name ?? "")" 
                                            data-service="@(appointment.Service?.Name ?? "")">
                                            <td>@appointment.AppointmentDate.ToString("dd.MM HH:mm")</td>
                                            <td>@(appointment.Staff?.Name ?? "?")</td>
                                            <td>
                                                @(appointment.Service?.Name ?? "?")
                                                @if (appointment.Service?.Price > 0)
                                                {
                                                    <span class="badge bg-secondary">@appointment.Service?.Price.ToString("N0") TL</span>
                                                }
                                            </td>
                                            <td>
                                                @if (appointment.IsCancelled)
                                                {
                                                    <span class="badge bg-danger">İptal</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">Aktif</span>
                                                }
                                            </td>
                                            <td>
                                                <a href="@Url.Action("Edit", "Appointments", new { id = appointment.Id })"
                                                    class="btn btn-warning btn-sm" data-bs-toggle="tooltip" title="Düzenle">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="@Url.Action("Delete", "Appointments", new { id = appointment.Id })"
                                                    class="btn btn-danger btn-sm" data-bs-toggle="tooltip" title="İptal Et">
                                                    <i class="fas fa-trash-alt"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="alert alert-info py-1" id="upcomingEmpty">Yaklaşan randevunuz bulunmamaktadır.</p>
                    }
                </div>
            </div>
        </div>

        <div class="accordion-item" id="pastSection">
            <h2 class="accordion-header" id="pastHeading">
                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse"
                    data-bs-target="#pastCollapse" aria-expanded="false" aria-controls="pastCollapse">
                    <i class="fas fa-history me-2"></i> Geçmiş Randevular
                    <span class="badge bg-secondary ms-2" id="pastCount">
                        @(Model.PastAppointments?.Count() ?? 0)
                    </span>
                </button>
            </h2>
            <div id="pastCollapse" class="accordion-collapse collapse" aria-labelledby="pastHeading">
                <div class="accordion-body p-2">
                    @if (Model.PastAppointments != null && Model.PastAppointments.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped appointment-table" id="pastTable">
                                <thead>
                                    <tr>
                                        <th>Tarih/Saat</th>
                                        <th>Personel</th>
                                        <th>Hizmet/Fiyat</th>
                                        <th>Durum</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var appointment in Model.PastAppointments)
                                    {
                                        <tr data-date="@appointment.AppointmentDate.ToString("yyyy-MM-ddTHH:mm:ss")" 
                                            data-staff="@(appointment.Staff?.Name ?? "")" 
                                            data-service="@(appointment.Service?.Name ?? "")">
                                            <td>@appointment.AppointmentDate.ToString("dd.MM HH:mm")</td>
                                            <td>@(appointment.Staff?.Name ?? "?")</td>
                                            <td>
                                                @(appointment.Service?.Name ?? "?")
                                                @if (appointment.Service?.Price > 0)
                                                {
                                                    <span class="badge bg-secondary">@appointment.Service?.Price.ToString("N0") TL</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge bg-info">Tamamlandı</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="alert alert-info py-1" id="pastEmpty">Geçmiş randevunuz bulunmamaktadır.</p>
                    }
                </div>
            </div>
        </div>

        <div class="accordion-item" id="cancelledSection">
            <h2 class="accordion-header" id="cancelledHeading">
                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse"
                    data-bs-target="#cancelledCollapse" aria-expanded="false" aria-controls="cancelledCollapse">
                    <i class="fas fa-ban me-2"></i> İptal Edilen Randevular
                    <span class="badge bg-danger ms-2" id="cancelledCount">
                        @(Model.CancelledAppointments?.Count() ?? 0)
                    </span>
                </button>
            </h2>
            <div id="cancelledCollapse" class="accordion-collapse collapse" aria-labelledby="cancelledHeading">
                <div class="accordion-body p-2">
                    @if (Model.CancelledAppointments != null && Model.CancelledAppointments.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-striped appointment-table" id="cancelledTable">
                                <thead>
                                    <tr>
                                        <th>Tarih/Saat</th>
                                        <th>Personel</th>
                                        <th>Hizmet/Fiyat</th>
                                        <th>Durum</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var appointment in Model.CancelledAppointments)
                                    {
                                        <tr data-date="@appointment.AppointmentDate.ToString("yyyy-MM-ddTHH:mm:ss")" 
                                            data-staff="@(appointment.Staff?.Name ?? "")" 
                                            data-service="@(appointment.Service?.Name ?? "")">
                                            <td>@appointment.AppointmentDate.ToString("dd.MM HH:mm")</td>
                                            <td>@(appointment.Staff?.Name ?? "?")</td>
                                            <td>
                                                @(appointment.Service?.Name ?? "?")
                                                @if (appointment.Service?.Price > 0)
                                                {
                                                    <span class="badge bg-secondary">@appointment.Service?.Price.ToString("N0") TL</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge bg-danger">İptal</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="alert alert-info py-1" id="cancelledEmpty">İptal edilmiş randevunuz bulunmamaktadır.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Auto-hide success message after 3 seconds
            window.setTimeout(function () {
                $(".alert-success").fadeTo(500, 0).slideUp(500, function () {
                    $(this).remove();
                });
            }, 3000);
            
            // Tooltip başlatma
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Arama işlevselliği
            $('#searchAppointments').on('keyup', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterAppointments(searchTerm);
            });
            
            // Filtreleme işlevselliği
            $('.filter-option').on('click', function(e) {
                e.preventDefault();
                const filter = $(this).data('filter');
                applyFilter(filter);
            });
            
            // Sıralama işlevselliği
            $('.sort-option').on('click', function(e) {
                e.preventDefault();
                const sortType = $(this).data('sort');
                sortAppointments(sortType);
            });
            
            // Randevuları filtrele
            function filterAppointments(searchTerm) {
                if (!searchTerm) {
                    $('.appointment-table tbody tr').show();
                    updateEmptyMessages();
                    return;
                }
                
                $('.appointment-table tbody tr').each(function() {
                    const $row = $(this);
                    const date = $row.data('date').toLowerCase();
                    const staff = $row.data('staff').toLowerCase();
                    const service = $row.data('service').toLowerCase();
                    const rowText = staff + ' ' + service + ' ' + date;
                    
                    if (rowText.indexOf(searchTerm) > -1) {
                        $row.show();
                    } else {
                        $row.hide();
                    }
                });
                
                updateEmptyMessages();
            }
            
            // Boş mesajlarını güncelle
            function updateEmptyMessages() {
                // Yaklaşan randevular
                const upcomingVisible = $('#upcomingTable tbody tr:visible').length;
                $('#upcomingEmpty').toggle(upcomingVisible === 0);
                $('#upcomingCount').text(upcomingVisible);
                
                // Geçmiş randevular
                const pastVisible = $('#pastTable tbody tr:visible').length;
                $('#pastEmpty').toggle(pastVisible === 0);
                $('#pastCount').text(pastVisible);
                
                // İptal edilen randevular
                const cancelledVisible = $('#cancelledTable tbody tr:visible').length;
                $('#cancelledEmpty').toggle(cancelledVisible === 0);
                $('#cancelledCount').text(cancelledVisible);
            }
            
            // Filtreleri uygula
            function applyFilter(filter) {
                if (filter === 'all') {
                    $('#upcomingSection, #pastSection, #cancelledSection').show();
                    return;
                }
                
                // Tüm bölümleri gizle
                $('#upcomingSection, #pastSection, #cancelledSection').hide();
                
                // Sadece seçilen bölümü göster
                if (filter === 'upcoming') {
                    $('#upcomingSection').show();
                    $('#upcomingCollapse').addClass('show');
                } else if (filter === 'past') {
                    $('#pastSection').show();
                    $('#pastCollapse').addClass('show');
                } else if (filter === 'cancelled') {
                    $('#cancelledSection').show();
                    $('#cancelledCollapse').addClass('show');
                }
            }
            
            // Randevuları sırala
            function sortAppointments(sortType) {
                $('.appointment-table').each(function() {
                    const $table = $(this);
                    const $rows = $table.find('tbody tr').toArray();
                    
                    $rows.sort(function(a, b) {
                        const dateA = new Date($(a).data('date'));
                        const dateB = new Date($(b).data('date'));
                        
                        if (sortType === 'date-asc') {
                            return dateA - dateB;
                        } else if (sortType === 'date-desc') {
                            return dateB - dateA;
                        }
                        return 0;
                    });
                    
                    // Sıralanan satırları tabloya ekle
                    $.each($rows, function(i, row) {
                        $table.find('tbody').append(row);
                    });
                });
            }
        });
    </script>
}
